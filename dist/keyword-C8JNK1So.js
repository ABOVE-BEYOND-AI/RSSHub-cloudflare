import"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import{cache_default as e}from"./cache-C3AIQtoX.js";import{art as t}from"./render-DE4LRFBD.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import{ofetch_default as r}from"./ofetch-DRl42yaJ.js";import{__dirname as i}from"./esm-shims-BDPl6Msv.js";import a from"node:path";import o from"node:crypto";import{Buffer as s}from"node:buffer";import{v4 as c}from"uuid";const l=`https://api.mercari.jp/`,u=`${l}v2/entities:search`,d=`${l}items/get`,f=`${l}v1/marketplaces/shops/products/`,p={default:``,onsale:`STATUS_ON_SALE`,soldout:`STATUS_SOLD_OUT`},m={default:`SORT_DEFAULT`,create_time:`SORT_CREATED_TIME`,like:`SORT_NUM_LIKES`,score:`SORT_SCORE`,price:`SORT_PRICE`},h={desc:`ORDER_DESC`,asc:`ORDER_ASC`};function g(e){return e.toString(`base64`).replaceAll(`+`,`-`).replaceAll(`/`,`_`).replaceAll(`=`,``)}function _(e){return g(s.from(e,`utf-8`))}function v(e){let t=e.export({format:`jwk`});return{crv:`P-256`,kty:`EC`,x:t.x,y:t.y}}function y(e){return{typ:`dpop+jwt`,alg:`ES256`,jwk:v(e)}}function b(e){let t=0;if(e[t++]!==48)throw Error(`Invalid DER signature`);let n=x(e,t);if(t+=n.bytesRead,e[t++]!==2)throw Error(`Expected INTEGER for R`);let r=x(e,t);t+=r.bytesRead;let i=e.subarray(t,t+r.length);if(t+=r.length,e[t++]!==2)throw Error(`Expected INTEGER for S`);let a=x(e,t);t+=a.bytesRead;let o=e.subarray(t,t+a.length);if(t+=a.length,t!==e.length)throw Error(`Extra bytes in DER signature`);return{r:S(i,32),s:S(o,32)}}function x(e,t){let n=e[t];if(n<128)return{length:n,bytesRead:1};let r=n&127;if(r>4)throw Error(`DER length too long`);let i=0;for(let n=0;n<r;n++)i=i<<8|e[t+1+n];return{length:i,bytesRead:1+r}}function S(e,t){if(e.length>t){let n=e.length-t;return e.subarray(n)}return e.length<t?s.concat([Uint8Array.from(s.alloc(t-e.length)),Uint8Array.from(e)]):e}function C({uuid:e,method:t,url:n}){let{privateKey:r,publicKey:i}=o.generateKeyPairSync(`ec`,{namedCurve:`prime256v1`}),a={iat:Math.floor(Date.now()/1e3),jti:e,htu:n,htm:t.toUpperCase()},c=y(i),l=_(JSON.stringify(c)),u=_(JSON.stringify(a)),d=`${l}.${u}`,f=o.createSign(`SHA256`);f.update(d);let p=f.sign(r),{r:m,s:h}=b(p),v=g(s.concat([Uint8Array.from(m),Uint8Array.from(h)]));return`${d}.${v}`}const w=async(e,t,n=`POST`)=>{let i=C({uuid:c(),method:n,url:e}),a=new Headers({DPOP:i,"X-Platform":`web`,"Accept-Encoding":`gzip, deflate`,"Content-Type":`application/json; charset=utf-8`}),o={method:n,headers:a,body:n===`POST`?JSON.stringify(t):void 0,query:n===`GET`?t:void 0};try{return await r(e,o)}catch(e){throw Error(`API request failed: ${e}`)}},T=e=>e===0?``:`v1:${e}`,E=async(e,t,n,r)=>{let i={userId:`MERCARI_BOT_${c()}`,pageSize:120,pageToken:T(0),searchSessionId:c(),indexRouting:`INDEX_ROUTING_UNSPECIFIED`,thumbnailTypes:[],searchCondition:{keyword:r,excludeKeyword:``,sort:e,order:t,status:[],sizeId:[],categoryId:[],brandId:[],sellerId:[],priceMin:0,priceMax:0,itemConditionId:[],shippingPayerId:[],shippingFromArea:[],shippingMethod:[],colorId:[],hasCoupon:!1,attributes:[],itemTypes:[],skuIds:[],shopIds:[],excludeShippingMethodIds:[]},serviceFrom:`suruga`,withItemBrand:!0,withItemSize:!1,withItemPromotions:!0,withItemSizes:!0,withShopname:!1,useDynamicAttribute:!0,withSuggestedItems:!0,withOfferPricePromotion:!0,withProductSuggest:!0,withParentProducts:!1,withProductArticles:!0,withSearchConditionId:!0,withAuction:!0};return await w(u,i,`POST`)},D=(e,t,n)=>t===`ITEM_TYPE_BEYOND`?w(f+e,{view:`FULL`,imageType:`JPEG`},`GET`):w(d,{id:e,country_code:n,include_item_attributes:!0,include_product_page_component:!0,include_non_ui_item_attributes:!0,include_donation:!0,include_offer_like_coupon_display:!0,include_offer_coupon_display:!0,include_item_attributes_sections:!0,include_auction:!1},`GET`),O=e=>{if(e.displayName){let r=e;return{title:r.displayName,description:t(a.join(i,`templates/shopItem-d63f5360.art`),r),pubDate:n(r.createTime),guid:r.name,link:`https://jp.mercari.com/shops/product/${r.name}`,image:r.thumbnail,language:`ja`,author:r.productDetail.shop.displayName,updated:n(r.updateTime)}}let r=e;return{title:r.data.name,description:t(a.join(i,`templates/item-fb30dd01.art`),r),pubDate:n(r.data.created*1e3),guid:r.data.id,link:`https://jp.mercari.com/item/${r.data.id}`,image:r.data.thumbnails[0],language:`ja`,author:r.data.seller.name,updated:n(r.data.updated*1e3)}},k={path:`/:sort/:order/:status/:keyword`,categories:[`shopping`],parameters:{sort:{description:`排序方式`,default:`default`,options:[{value:`default`,label:`默认排序`},{value:`create_time`,label:`发布时间`},{value:`score`,label:`评分`},{value:`like`,label:`点赞`},{value:`price`,label:`价格`}]},order:{description:`排序顺序`,default:`desc`,options:[{value:`desc`,label:`降序`},{value:`asc`,label:`升序`}]},status:{description:`商品状态`,default:`default`,options:[{value:`default`,label:`全部`},{value:`onsale`,label:`在售`},{value:`soldout`,label:`已售`}]},keyword:{description:`关键词`}},example:`/mercari/create_time/desc/default/ふもふも`,features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`关键词`,maintainers:[`yana9i`],url:`jp.mercari.com`,handler:A};async function A(t){let{sort:n,order:r,status:i,keyword:a}=t.req.param(),o=(await E(m[n],h[r],p[i],a)).items,s=await Promise.all(o.map(t=>e.tryGet(`mercari:${t.id}`,async()=>await D(t.id,t.itemType).then(e=>O(e)))));return{title:`${a} の検索結果`,link:`https://jp.mercari.com/search?sort=${m[n]}&order=${h[r]}&status=${p[i]}&keyword=${encodeURIComponent(a)}`,description:`Search results for keyword: ${a}`,item:s}}export{k as route};