import"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import"./helpers-LVq640iW.js";import{art as e}from"./render-DE4LRFBD.js";import{parseDate as t}from"./parse-date-DHsdom8D.js";import"./ofetch-DRl42yaJ.js";import{__dirname as n}from"./esm-shims-BDPl6Msv.js";import{got_default as r}from"./got-BaOFZRd4.js";import i from"node:path";import{load as a}from"cheerio";const o={metascore:{id:`metaScore`,name:`Metascore`},userscore:{id:`userScore`,name:`User Score`},popular:{id:`popularityCount`,name:`Most Popular`},new:{id:`releaseDate`,name:`Releases`}},s={game:{id:`games`,name:`Games`},movie:{id:`movies`,name:`Movies`},tv:{id:`tv`,name:`TV Shows`},albums:{id:`albums`,name:`Music`}},c={path:`/:type?/:sort?/:filter?`,name:`Unknown`,maintainers:[],handler:l};async function l(c){let{type:l=`game`,sort:u=`new`,filter:d}=c.req.param(),f=c.req.query(`limit`)?Number.parseInt(c.req.query(`limit`),10):50,p=`https://www.metacritic.com`,m=new URL(`finder/metacritic/web`,`https://backend.metacritic.com`).href,h=new URL(`/browse/${l}/all/all/all-time/${u}/${d?`?${d}`:``}`,p),g=h.searchParams,_=h.href,{data:v}=await r(_),y=v.match(/apiKey=(.*?)&/)[1],b={sortBy:`-${o[u].id}`,productType:s[l].id,limit:f,apiKey:y},x=g.getAll(`genre`).join(`,`).toLowerCase(),S=g.getAll(`releaseType`).join(`,`),C=g.get(`releaseYearMin`),w=g.get(`releaseYearMax`);x&&(b.genres=x),S&&(b.releaseType=S),C&&(b.releaseYearMin=C),w&&(b.releaseYearMax=w);let T=g.getAll(`platform`),E=g.getAll(`network`);if(T.length||E.length){let e={},t=String.raw`{label:"([^"]+)",value:(\d+),href:a,meta:{mcDisplayWeight`;for(let n of v.match(new RegExp(t,`g`))){let r=n.match(new RegExp(t));e[r[1].toLowerCase().split(/(\s\(|\\u002f(?!\s))/)[0].replaceAll(`-`,`---`).replaceAll(/\s\/\s/g,`-or-`).replaceAll(`+`,`-plus`).replaceAll(/\s/g,`-`)]=r[2]}T.length&&(b.gamePlatformIds=T.map(t=>Object.hasOwn(e,t)?e[t]:void 0).filter(Boolean).join(`,`)),E.length&&(b.streamingNetworkIds=E.map(t=>Object.hasOwn(e,t)?e[t]:void 0).filter(Boolean).join(`,`))}let{data:D}=await r(m,{searchParams:b}),O=D.data.items.slice(0,f).map(r=>({title:r.title,link:new URL(`${l}/${r.slug}`,p).href,description:e(i.join(n,`templates/description-dc1efad7.art`),{image:r.image?{src:new URL(`a/img/catalog${r.image.bucketPath}`,p).href,alt:r.image.alt}:void 0,description:r.description,score:r.criticScoreSummary?.score??void 0}),category:r.genres?.map(e=>e.name),guid:`metacritic-${r.id}`,pubDate:t(r.releaseDate),upvotes:r.criticScoreSummary?.positiveCount?Number.parseInt(r.criticScoreSummary?.positiveCount,10):0,downvotes:r.criticScoreSummary?.negativeCount?Number.parseInt(r.criticScoreSummary?.negativeCount,10):0,comments:r.criticScoreSummary?.reviewCount?Number.parseInt(r.criticScoreSummary?.reviewCount,10):0})),k=a(v),A=new URL(k(`meta[data-hid="msapplication-task-metacritic"]`).prop(`content`).split(`icon-uri=`).pop(),p).href;return{item:O,title:k(`title`).text(),link:_,description:k(`meta[name="description"]`).prop(`content`),language:k(`html`).prop(`lang`),image:k(`link[rel="icon"]`).prop(`content`),icon:A,logo:A,subtitle:k(`meta[name="msapplication-tooltip"]`).prop(`content`),author:k(`meta[name="twitter:site"]`).prop(`content`),allowEmpty:!0}}export{c as route};