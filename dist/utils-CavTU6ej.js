import{cache_default as e}from"./cache-C3AIQtoX.js";import{art as t}from"./render-DE4LRFBD.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import{ofetch_default as r}from"./ofetch-DRl42yaJ.js";import{__dirname as i}from"./esm-shims-BDPl6Msv.js";import{got_default as a}from"./got-BaOFZRd4.js";import o from"node:path";import{load as s}from"cheerio";import{destr as c}from"destr";const l=`https://www.bloomberg.com/feeds`,u={accept:`application/json`,"cache-control":`no-cache`,referer:`https://www.bloomberg.com`},d={articles:{url:`https://www.bloomberg.com/article/api/story/slug/`},features:{url:`https://www.bloomberg.com/article/api/story/slug/`},audio:{url:`https://www.bloomberg.com/news/audio/`,sel:`script#__NEXT_DATA__`},videos:{url:`https://www.bloomberg.com/news/videos/`,sel:`script`},newsletters:{url:`https://www.bloomberg.com/article/api/story/slug/`},"photo-essays":{url:`https://www.bloomberg.com/javelin/api/photo-essay_transporter/`,sel:`script[type = "application/json"][data-component-props]`},"features/":{url:`https://www.bloomberg.com/features/`,sel:`script[id^="article-info"][type="application/json"], script[class^="article-info"][type="application/json"], script#dvz-config`,prop:`id`}},f=/\/(?<page>[\w-]*?)\/(?<link>\d{4}-\d{2}-\d{2}\/.*)/,p=/(?<!news|politics)\/(?<page>features\/|graphics\/)(?<link>.*)/,m=[f,p],h=/<p>|<\/p>/g,g=/<p\b[^>]*>(&nbsp;|\s)<\/p>/g,_=e=>r.raw(e,{headers:u,parseResponse:e=>({data:c(e),body:e})}),v=async(e,t)=>{let r=await a(e),i=s(r.data,{xml:{xmlMode:!0}}),o=i(`urlset url`);return o.toArray().slice(0,t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`)):50).map(e=>{e=i(e);let t={title:e.find(String.raw`news\:title`).text(),link:e.find(`loc`).text(),pubDate:n(e.find(String.raw`news\:publication_date`).text())};return t})},y=t=>e.tryGet(t.link,async()=>{let e=m.map(e=>e.exec(t.link)).filter(e=>e&&e.groups).map(e=>e&&e.groups)[0];if(e){let{page:n,link:r}=e;if(d[n]){let e={...d[n]},i;try{let t=`${e.url}${r}`;i=await _(t)}catch(e){if(e.name&&(e.name===`HTTPError`||e.name===`RequestError`||e.name===`FetchError`))try{i=await _(t.link)}catch{return{title:t.title,link:t.link,pubDate:t.pubDate}}}if(i.redirected&&new URL(i.url).pathname===`/tosv2.html`||i.status===404)return{title:t.title,link:t.link,pubDate:t.pubDate};switch(n){case`audio`:return b(i._data,e,t);case`videos`:return x(i._data,e,t);case`photo-essays`:return S(i._data,e,t);case`features/`:return C(i._data,e,t);default:return w(i._data.data,t)}}}return t}),b=async(e,t,r)=>{let i=JSON.parse(s(e.data)(t.sel).html()).props.pageProps,a=i.episode,o={title:a.title||r.title,link:i.pageInfo.canonicalUrl||r.link,guid:`bloomberg:${a.id}`,description:(await D(a.articleBody,i)).replaceAll(g,``),pubDate:n(a.publishedAt)||r.pubDate,author:i.hero.showTitle,media:{content:{url:a.image},thumbnails:{url:a.image}},enclosure_type:`audio/mpeg`,enclosure_url:a.url,itunes_item_image:a.image||i.pageInfo.image.url};return o},x=async(e,r,a)=>{let c=s(e.data),l=c(r.sel).filter((e,t)=>c(t).text().includes(`__PRELOADED_STATE__`)),u=l.text().trim().match(/window\.__PRELOADED_STATE__ = (.*?);/)?.[1],d=JSON.parse(u||`{}`),f=d.video?.videoStory??d.quicktakeVideo?.videoStory;if(f){let e=await O(f.video.bmmrId,f.summary.html.replaceAll(g,``)),r={title:f.headline.text||a.title,link:f.url||a.link,guid:`bloomberg:${f.id}`,description:t(o.join(i,`templates/video_media-86c5e7ff.art`),e),pubDate:n(f.publishedAt)||a.pubDate,media:{content:{url:f.video?.thumbnail.url||``},thumbnails:{url:f.video?.thumbnail.url||``}},category:e.keywords??[]};return r}return a},S=async(e,t,n)=>{let r=s(e.data.html),i={};for(let e of r(t.sel).toArray())Object.assign(i,JSON.parse(r(e).html()));let a={title:i.headline||n.title,link:i.canonical||n.link,guid:`bloomberg:${i.id}`,description:(await D(i.body,i)).replaceAll(g,``),pubDate:n.pubDate,author:i.authors?.map(e=>e.name).join(`, `)??[]};return a},C=async(e,t,n)=>{let r=s(e.data)(t.sel).text().trim(),i=JSON.parse(r)[t.prop];try{let e=await _(`https://www.bloomberg.com/article/api/story/id/${i}`);return await w(e._data,n)}catch(e){if(e.name&&(e.name===`HTTPError`||e.name===`RequestError`||e.name===`FetchError`))return{title:n.title,link:n.link,pubDate:n.pubDate}}},w=async(e,t)=>{let r=e.ledeImageUrl||Object.values(e.imageAttachments??{})[0]?.url,i={title:e.headline||t.title,link:e.url||t.link,guid:`bloomberg:${e.id}`,description:T(e)+await E(e)+await N(e.body||``),pubDate:n(e.publishedAt)||t.pubDate,author:e.authors?.map(e=>e.name).join(`, `)??[],category:e.mostRelevantTags??[],media:{content:{url:r},thumbnails:{url:r}}};return i},T=e=>{let t=e.dek||e.summary||e.headline||``,n=e.abstract?.map(e=>`<li>${e}</li>`).join(``);return n?t+`<ul>${n}</ul>`:t},E=async e=>{if(e.ledeMediaKind){let n=e.ledeMediaKind,r={kind:e.ledeMediaKind,caption:e.ledeCaption?.replaceAll(h,``)??``,description:e.ledeDescription?.replaceAll(h,``)??``,credit:e.ledeCredit?.replaceAll(h,``)??``,src:e.ledeImageUrl,video:n===`video`&&await O(e.ledeAttachment.bmmrId)};return t(o.join(i,`templates/lede_media-39081938.art`),{media:r})}else if(e.lede){let n=e.lede,r={src:n.url,alt:n.alt||n.title,caption:n.caption?.replaceAll(h,``)??``,credit:n.credit?.replaceAll(h,``)??``};return t(o.join(i,`templates/image_figure-1ba8d11c.art`),r)}else if(e.imageAttachments){let n=Object.values(e.imageAttachments)[0];if(n){let e={src:n.baseUrl||n.url,alt:n.alt||n.title,caption:n.caption?.replaceAll(h,``)??``,credit:n.credit?.replaceAll(h,``)??``};return t(o.join(i,`templates/image_figure-1ba8d11c.art`),e)}return``}else if(e.type===`Lede`){let n=e.props,r={kind:n.media,caption:n.caption?.replaceAll(h,``)??``,description:n.dek?.replaceAll(h,``)??``,credit:n.credit?.replaceAll(h,``)??``,src:n.url};return t(o.join(i,`templates/lede_media-39081938.art`),{media:r})}},D=async(e,n)=>{let r=[`meta`,`script`,`*[class$="-footnotes"]`,`*[class$="for-you"]`,`*[class$="-newsletter"]`,`*[class$="page-ad"]`,`*[class$="-recirc"]`,`*[data-ad-placeholder="Advertisement"]`],a=s(e);for(let e of r)a(e).remove();a(`.paywall`).removeAttr(`class`);for await(let e of a(`figure`)){let r=a(e).data(`image-type`),s=a(e).data(`type`),c=``;if(r===`audio`){let r={};if(n.audios){let t=n.audios.find(t=>t.id.toString()===a(e).data(`id`).toString());r={img:t.image?.url||a(e).find(`img`).attr(`src`),src:t.url||a(e).find(`audio source`).attr(`src`),caption:a(e).find(`[class$="text"]`).html()?.trim()??``,credit:a(e).find(`[class$="credit"]`).html()?.trim()??``}}if(n.episode){let t=n.episode;r={src:t.url,img:t.image||n.pageInfo.image.url,caption:t.description||(a(e).find(`[class$="text"]`).html()?.trim()??``),credit:(t.credits.map(e=>e.name).join(`, `)??[])||(a(e).find(`[class$="credit"]`).html()?.trim()??``)}}c=t(o.join(i,`templates/audio_media-302de55e.art`),r)}else if(r===`video`){if(n.videoAttachments){let r=n.videoAttachments[a(e).data(`id`)],s=await O(r.bmmrId);c=t(o.join(i,`templates/video_media-86c5e7ff.art`),s)}}else if(r===`photo`||r===`image`||s===`image`){let r,s;if(n.imageAttachments){let t=n.imageAttachments[a(e).data(`id`)];s=t?.alt||a(e).find(`img`).attr(`alt`)?.trim(),r=t?.baseUrl}else s=a(e).find(`img`).attr(`alt`).trim(),r=a(e).find(`img`).data(`native-src`);let l=a(e).find(`[class$="text"], .caption, .photo-essay__text`).html()?.trim()??``,u=a(e).find(`[class$="credit"], .credit, .photo-essay__source`).html()?.trim()??``,d={src:r,alt:s,caption:l,credit:u};c=t(o.join(i,`templates/image_figure-1ba8d11c.art`),d)}a(c).insertAfter(e),a(e).remove()}return a.html()},O=async(e,t)=>{let n=`https://www.bloomberg.com/multimedia/api/embed?id=${e}`,r=await _(n);if(r.redirected&&new URL(r.url).pathname===`/tosv2.html`||r.status===404)return{stream:``,mp4:``,coverUrl:``,caption:t};if(r._data.data){let e=r._data.data;return{stream:e.streams?e.streams[0]?.url:``,mp4:e.downloadURLs?e.downloadURLs[600]:``,coverUrl:e.thumbnail?.baseUrl??``,caption:e.description||e.title||t}}return{stream:``,mp4:``,coverUrl:``,caption:t}},k={paragraph:async(e,t)=>`<p>${await t(e.content)}</p>`,text:e=>{let{attributes:t,value:n}=e;return t?.emphasis&&t?.strong?`<strong><em>${n}</em></strong>`:t?.emphasis?`<em>${n}</em>`:t?.strong?`<strong>${n}</strong>`:n},"inline-newsletter":async(e,t)=>`<div>${await t(e.content)}</div>`,"inline-recirc":async(e,t)=>`<div>${await t(e.content)}</div>`,heading:async(e,t)=>{let n=e.data;if(n.level===2||n.level===3)return`<h3>${await t(e.content)}</h3>`},link:async(e,t)=>{let n=e.data.destination,r=n.web,i=n.bbg,a=e.data.title;if(r)return`<a href="${r}" title="${a}" target="_blank">${await t(e.content)}</a>`;if(i&&i.startsWith(`bbg://news/stories`)){let n=i.split(`bbg://news/stories/`).pop(),r=`https://www.bloomberg.com/news/terminal/${n}`;return`<a href="${r}" title="${a}" target="_blank">${await t(e.content)}</a>`}return String(await t(e.content))},entity:async(e,t)=>{let n=e.subType,r=e.data.link.destination,i=r.web;if(n===`person`)return t(e.content);if(n===`story`){if(i)return`<a href="${i}" target="_blank">${await t(e.content)}</a>`;let n=e.data.story.identifiers.suid,r=`https://www.bloomberg.com/news/terminal/${n}`;return`<a href="${r}" target="_blank">${await t(e.content)}</a>`}if(n===`security`){let n=e.data.security.identifiers.parsekey;if(n){let r=n.split(` `),i=[...`https://www.bloomberg.com/quote/${r[0]}:`,r[1]];return`<a href="${i}" target="_blank">${await t(e.content)}</a>`}}return t(e.content)},br:()=>`<br/>`,hr:()=>`<br/>`,ad:()=>{},blockquote:async(e,t)=>`<blockquote>${await t(e.content)}</blockquote>`,quote:async(e,t)=>`<blockquote>${await t(e.content)}</blockquote>`,aside:async(e,t)=>`<aside>${await t(e.content)}</aside>`,list:async(e,t)=>{let n=e.subType;if(n===`unordered`)return`<ul>${await t(e.content)}</ul>`;if(n===`ordered`)return`<ol>${await t(e.content)}</ol>`},listItem:async(e,t)=>`<li>${await t(e.content)}</li>`,media:async e=>{let n=e.subType;if(n===`chart`&&e.data.attachment){if(e.data.attachment.creator===`TOASTER`){let n=e.data.chart,r={src:n&&n.fallback||``,chart:e.data.attachment,id:n&&n.id||``,alt:n&&n.alt||``},a=r.chart,s={source:a.source,footnote:a.footnote,url:a.url,title:a.title,subtitle:a.subtitle,chartId:`toaster-chart-${r.id}`,chartAlt:r.alt,fallback:r.src};return t(o.join(i,`templates/chart_media-e91db148.art`),{chart:s})}let n={alt:e.data.attachment?.footnote||``,caption:e.data.attachment?.title+e.data.attachment.subtitle||``,credit:e.data.attachment?.source||``,src:e.data.chart?.fallback||``};return t(o.join(i,`templates/image_figure-1ba8d11c.art`),n)}if(n===`photo`){let n=e.data,r=``;if(n.attachment){let e={src:n.photo?.src,alt:n.photo?.alt,caption:n.photo?.caption,credit:n.photo?.credit};r=t(o.join(i,`templates/image_figure-1ba8d11c.art`),e)}if(n.link&&n.link.destination&&n.link.destination.web){let e=n.link.destination.web;return`<a href="${e}" target="_blank">${r}</a>`}return r}if(n===`video`){let n=e.data,r=n.attachment?.id;if(r){let e=await O(r,n.attachment?.title);return t(o.join(i,`templates/video_media-86c5e7ff.art`),e)}}if(n===`audio`&&e.data.attachment){let n=e.data.attachment,r=n.title,a=n.url,s=n.image;if(r&&a){let e={src:a,img:s.url,caption:r,credit:``};return t(o.join(i,`templates/audio_media-302de55e.art`),e)}}return``},tabularData:async(e,t)=>`<table>${await t(e.content)}</table>`,columns:e=>{let t=e.data.definitions.map(e=>({title:e.title,span:e.colSpan||1,type:e.dataType})).map(e=>`<th colspan=${e.span}>${e.title}</th>`);return`<tr>${t}</tr>`},row:async(e,t)=>`<tr>${await t(e.content)}</tr>`,cell:async(e,t)=>{let n={"news-rsf-table-number":`number`,"news-rsf-table-string":`text`},r=n[e.data.class]||`text`;return`<td data-coltype=${r} colspan=${e.data.colspan}>${await t(e.content)}</td>`}},A=async e=>{let t=await M(e);return t},j=async(e,t)=>{if(!e.type||!k[e.type])return`<node>${e.type}</node>`;let n=await k[e.type](e,A,t);return n},M=async e=>{let t=await Promise.all(e.map(async(t,n)=>{let r=await j(t,{index:n,prev:e[n-1]?.type,next:e[n+1]?.type});return r}));return t.join(``)},N=async e=>{if(!e||!e.content)return``;let t=await M(e.content);return t};export{y as parseArticle,v as parseNewsList,l as rootUrl};