import{config as e}from"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import"./cache-C3AIQtoX.js";import{art as t}from"./render-DE4LRFBD.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import"./ofetch-DRl42yaJ.js";import{__dirname as r}from"./esm-shims-BDPl6Msv.js";import{invalid_parameter_default as i}from"./invalid-parameter-CfUmvEUg.js";import{config_not_found_default as a}from"./config-not-found-B7nOMdXp.js";import{queryToBoolean as o}from"./readable-social-Dobs5p4y.js";import{VALID_HAS_TYPES as s,baseUrl as c,getGuild as l,searchGuildMessages as u}from"./discord-api-uyOvnWT_.js";import d from"node:path";const f={path:`/search/:guildId/:routeParams`,categories:[`social-media`],example:`/discord/search/302094807046684672/content=friendly&has=image,video`,parameters:{guildId:`Guild ID`,routeParams:`Search parameters, support content, author_id, mentions, has, min_id, max_id, channel_id, pinned`},features:{requireConfig:[{name:`DISCORD_AUTHORIZATION`,description:`Discord authorization header`}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`Guild Search`,maintainers:[`NekoAria`],handler:m},p=e=>{let t=new URLSearchParams(e),n=t.get(`has`)?.split(`,`).filter(Boolean),r=n?.filter(e=>s.has(e)),i={content:t.get(`content`)??void 0,author_id:t.get(`author_id`)??void 0,mentions:t.get(`mentions`)??void 0,has:r?.length?r:void 0,min_id:t.get(`min_id`)??void 0,max_id:t.get(`max_id`)??void 0,channel_id:t.get(`channel_id`)??void 0,pinned:t.has(`pinned`)?o(t.get(`pinned`)):void 0};return Object.fromEntries(Object.entries(i).filter(([,e])=>e!==void 0))};async function m(o){let{authorization:s}=e.discord||{};if(!s)throw new a(`Discord RSS is disabled due to the lack of authorization config`);let{guildId:f}=o.req.param(),m=p(o.req.param(`routeParams`));if(!Object.keys(m).length)throw new i(`At least one valid search parameter is required`);let[h,g]=await Promise.all([l(f,s),u(f,s,m)]);if(!g?.messages?.length)return{title:`Search Results - ${h.name}`,link:`${c}/channels/${f}`,item:[],allowEmpty:!0};let _=g.messages.flat().map(e=>({title:e.content.split(`
`)[0]||`(no content)`,description:t(d.join(r,`templates/message-311bc85b.art`),{message:e,guildInfo:h}),author:e.author.global_name??e.author.username,pubDate:n(e.timestamp),updated:e.edited_timestamp?n(e.edited_timestamp):void 0,category:[`#${e.channel_id}`],link:`${c}/channels/${f}/${e.channel_id}/${e.id}`})),v=Object.entries(m).filter(([,e])=>e!==void 0).map(([e,t])=>`${e}:${Array.isArray(t)?t.join(`,`):t}`).join(` `);return{title:`Search "${v}" in ${h.name} - Discord`,link:`${c}/channels/${f}`,item:_,allowEmpty:!0}}export{f as route};