import{config as e}from"./config-HRWLmo66.js";import{cache_default as t}from"./cache-C3AIQtoX.js";import{art as n}from"./render-DE4LRFBD.js";import{parseDate as r}from"./parse-date-DHsdom8D.js";import{ofetch_default as i}from"./ofetch-DRl42yaJ.js";import{not_found_default as a}from"./not-found-BfsMaUzS.js";import{__dirname as o}from"./esm-shims-BDPl6Msv.js";import s from"node:path";import c from"dayjs";import l from"dayjs/plugin/duration.js";import*as u from"cheerio";import{google as d}from"googleapis";const{OAuth2:f}=d.auth;c.extend(l);let p=0;const m={};if(e.youtube&&e.youtube.key){let t=e.youtube.key.split(`,`);for(let[e,n]of t.entries())n&&(m[e]=d.youtube({version:`v3`,auth:n}),p=e+1)}let h=-1;const g=async e=>{let t;for(let n=0;n<p;n++){h++;try{t=await e(m[h%p]);break}catch{}}return t};let _;e.youtube&&e.youtube.clientId&&e.youtube.clientSecret&&e.youtube.refreshToken&&(_=new f(e.youtube.clientId,e.youtube.clientSecret,`https://developers.google.com/oauthplayground`),_.setCredentials({refresh_token:e.youtube.refreshToken}));const v=async({username:e,embed:n,filterShorts:o})=>{let s;e.startsWith(`@`)&&(s=await t.tryGet(`youtube:handle:${e}`,async()=>{let n=`https://www.youtube.com/${e}`,r=await i(n),a=u.load(r),o=JSON.parse(a(`script`).text().match(/ytInitialData = ({.*?});/)?.[1]||`{}`),s=o.metadata.channelMetadataRenderer,c=s.externalId,l=s.title,d=s.avatar?.thumbnails?.[0]?.url,f=s.description,p=(await I.getChannelWithId(c,`contentDetails`,t)).data.items[0].contentDetails.relatedPlaylists.uploads;return{channelName:l,image:d,description:f,playlistId:p}}));let l=await(async()=>{if(s?.playlistId){let e=s.playlistId;return I.getPlaylistWithShortsFilter(e,o)}else{let n=await I.getChannelWithUsername(e,`contentDetails`,t),r=n.data.items;if(!r)throw new a(`The channel https://www.youtube.com/user/${e} does not exist.`);let i=r[0].id;return o?I.getPlaylistWithShortsFilter(i,o):r[0].contentDetails.relatedPlaylists.uploads}})(),d=await I.getPlaylistItems(l,`snippet`,t);if(!d)throw new a(`This channel doesn't have any content.`);let f=d.data.items.map(e=>e.snippet.resourceId.videoId).join(`,`),p=await I.getVideos(f,`contentDetails`,t);return{title:`${s?.channelName||e} - YouTube`,link:e.startsWith(`@`)?`https://www.youtube.com/${e}`:`https://www.youtube.com/user/${e}`,description:s?.description||`YouTube user ${e}`,image:s?.image,item:d.data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let t=e.snippet,i=t.resourceId.videoId,a=I.getThumbnail(t.thumbnails),o=p?.data.items.find(e=>e.id===i);return{title:t.title,description:I.renderDescription(n,i,a,I.formatDescription(t.description)),pubDate:r(t.publishedAt),link:`https://www.youtube.com/watch?v=${i}`,author:t.videoOwnerChannelTitle,image:a.url,attachments:[{url:N(i),mime_type:`text/html`,duration_in_seconds:o?.contentDetails.duration?c.duration(o.contentDetails.duration).asSeconds():void 0}]}})}},y=async({channelId:e,embed:n,filterShorts:i})=>{let a=i?null:(await I.getChannelWithId(e,`contentDetails`,t)).data.items[0].contentDetails.relatedPlaylists.uploads,o=i?I.getPlaylistWithShortsFilter(e):a,s=(await I.getPlaylistItems(o,`snippet`,t)).data.items,l=s.map(e=>e.snippet.resourceId.videoId).join(`,`),u=await I.getVideos(l,`contentDetails`,t);return{title:`${s[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/channel/${e}`,description:`YouTube channel ${s[0].snippet.channelTitle}`,item:s.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let t=e.snippet,i=t.resourceId.videoId,a=I.getThumbnail(t.thumbnails),o=u?.data.items.find(e=>e.id===i);return{title:t.title,description:I.renderDescription(n,i,a,I.formatDescription(t.description)),pubDate:r(t.publishedAt),link:`https://www.youtube.com/watch?v=${i}`,author:t.videoOwnerChannelTitle,image:a.url,attachments:[{url:N(i),mime_type:`text/html`,duration_in_seconds:o?.contentDetails.duration?c.duration(o.contentDetails.duration).asSeconds():void 0}]}})}},b=async({playlistId:e,embed:n})=>{let i=(await I.getPlaylist(e,`snippet`,t)).data.items[0].snippet.title,a=(await I.getPlaylistItems(e,`snippet`,t)).data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`),o=a.map(e=>e.snippet.resourceId.videoId).join(`,`),s=await I.getVideos(o,`contentDetails`,t);return{title:`${i} by ${a[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/playlist?list=${e}`,description:`${i} by ${a[0].snippet.channelTitle}`,item:a.map(e=>{let t=e.snippet,i=t.resourceId.videoId,a=I.getThumbnail(t.thumbnails),o=s?.data.items.find(e=>e.id===i);return{title:t.title,description:I.renderDescription(n,i,a,I.formatDescription(t.description)),pubDate:r(t.publishedAt),link:`https://www.youtube.com/watch?v=${i}`,author:t.videoOwnerChannelTitle,image:a.url,attachments:[{url:N(i),mime_type:`text/html`,duration_in_seconds:o?.contentDetails.duration?c.duration(o.contentDetails.duration).asSeconds():void 0}]}})}},x=(t,n,r)=>r.tryGet(`youtube:getPlaylistItems:${t}`,async()=>{let e=await g(e=>e.playlistItems.list({part:n,playlistId:t,maxResults:50}));return e},e.cache.routeExpire,!1),S=(e,t,n)=>n.tryGet(`youtube:getPlaylist:${e}`,async()=>{let n=await g(n=>n.playlists.list({part:t,id:e}));return n}),C=(e,t,n)=>n.tryGet(`youtube:getChannelWithId:${e}`,async()=>{let n=await g(n=>n.channels.list({part:t,id:e}));return n}),w=(e,t,n)=>n.tryGet(`youtube:getChannelWithUsername:${e}`,async()=>{let n=await g(n=>n.channels.list({part:t,forUsername:e}));return n}),T=(e,t,n)=>n.tryGet(`youtube:getVideos:${e}`,async()=>{let n=await g(n=>n.videos.list({part:t,id:e}));return n}),E=e=>e.maxres||e.standard||e.high||e.medium||e.default,D=e=>e?.replaceAll(/\r\n|\r|\n/g,`<br>`),O=(e,t,r,i)=>n(s.join(o,`templates/description-e0f4b632.art`),{embed:e,videoId:t,img:r,description:i}),k=async(t,n)=>{let r=await n.get(`youtube:accessToken`,!1);if(!r){let e=await _.getAccessToken();r=e.token,await n.set(`youtube:accessToken`,r,3600)}return _.setCredentials({access_token:r,refresh_token:e.youtube.refreshToken}),n.tryGet(`youtube:getSubscriptions`,()=>A(t),e.cache.routeExpire,!1)};async function A(e,t){let n=await d.youtube(`v3`).subscriptions.list({auth:_,part:e,mine:!0,maxResults:50,pageToken:t??void 0});if(n.data.nextPageToken){let t=await A(e,n.data.nextPageToken);t.data.items&&(n.data.items=[...n.data.items||[],...t.data.items])}return n}const j=e=>/^UC[\w-]{21}[AQgw]$/.test(e),M=(e,t)=>t.tryGet(`youtube:getLive:${e}`,async()=>{let t=await g(t=>t.search.list({part:`snippet`,channelId:e,eventType:`live`,type:`video`}));return t}),N=e=>`https://www.youtube-nocookie.com/embed/${e}?controls=1&autoplay=1&mute=0`,P=(e,t=!0)=>t&&(e.startsWith(`UC`)||e.startsWith(`UU`))?`UULF`+e.slice(2):e,F=async({googleApi:t,youtubeiApi:n,params:r})=>{if(e.youtube?.key)try{return await t(r)}catch{return await n(r)}return await n(r)};var I={getPlaylistItems:x,getPlaylist:S,getChannelWithId:C,getChannelWithUsername:w,getVideos:T,getThumbnail:E,formatDescription:D,renderDescription:O,getSubscriptions:k,getSubscriptionsRecusive:A,isYouTubeChannelId:j,getLive:M,getVideoUrl:N,getPlaylistWithShortsFilter:P};export{F as callApi,y as getDataByChannelId,b as getDataByPlaylistId,v as getDataByUsername,N as getVideoUrl,j as isYouTubeChannelId,O as renderDescription,I as utils_default};