import"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import"./helpers-LVq640iW.js";import{cache_default as e}from"./cache-C3AIQtoX.js";import{art as t}from"./render-DE4LRFBD.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import"./ofetch-DRl42yaJ.js";import{__dirname as r}from"./esm-shims-BDPl6Msv.js";import{got_default as i}from"./got-BaOFZRd4.js";import a from"node:path";import{load as o}from"cheerio";const s=`https://kemono.cr`,c=`${s}/api/v1`,l={m4a:`audio/mp4`,mp3:`audio/mpeg`,mp4:`video/mp4`},u={Accept:`text/css`},d={path:`/:source?/:id?/:type?`,categories:[`anime`],example:`/kemono`,parameters:{source:`Source, see below, Posts by default`,id:`User id, can be found in URL`,type:`Content type: announcements or fancards`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1,nsfw:!0},radar:[{source:[`kemono.cr/`],target:``},{source:[`kemono.cr/:source/user/:id`],target:`/:source/:id`},{source:[`kemono.cr/:source/user/:id/announcements`],target:`/:source/:id/announcements`},{source:[`kemono.cr/:source/user/:id/fancards`],target:`/:source/:id/fancards`},{source:[`kemono.cr/discord/server/:id`],target:`/discord/:id`}],name:`Posts`,maintainers:[`nczitzk`,`AiraNadih`],handler:C,description:`Sources

| Posts | Patreon | Pixiv Fanbox | Gumroad | SubscribeStar | DLsite | Discord | Fantia |
| ----- | ------- | ------------ | ------- | ------------- | ------ | ------- | ------ |
| posts | patreon | fanbox       | gumroad | subscribestar | dlsite | discord | fantia |

::: tip
  When \`posts\` is selected as the value of the parameter **source**, the parameter **id** does not take effect.
  There is an optinal parameter **limit** which controls the number of posts to fetch, default value is 25.
  
  Support for announcements and fancards:
  - Use \`/:source/:id/announcements\` to get announcements
  - Use \`/:source/:id/fancards\` to get fancards
:::`};function f(e){if(typeof e!=`string`)return e;try{let t=JSON.parse(e);return typeof t==`string`&&(t=JSON.parse(t)),t}catch{return e}}function p(e,t,n){if(e===`posts`)return`${c}/posts`;if(e===`discord`&&t)return`${c}/discord/channel/lookup/${t}`;if(!t)throw Error(`User ID is required for non-posts sources`);let r=`${c}/${e}/user/${t}`;return n?`${r}/${n}`:`${r}/posts`}function m(e,t,n){if(e===`posts`)return`${s}/posts`;if(e===`discord`&&t)return`${s}/${e}/server/${t}`;if(!t)throw Error(`User ID is required for non-posts sources`);let r=`${s}/${e}/user/${t}`;return n?`${r}/${n}`:r}async function h(e,t){try{let n=`${c}/${e}/user/${t}/profile`,r=await i({method:`get`,url:n,headers:u});return r.data.name||`Unknown User`}catch{return`Unknown User`}}function g(e){let t=[];if(e.file){let n=f(e.file);n&&typeof n==`object`&&`path`in n&&t.push({name:n.name||`Unnamed File`,path:n.path,extension:_(n.path)})}if(Array.isArray(e.attachments))for(let n of e.attachments){let e=f(n);e&&typeof e==`object`&&`path`in e&&t.push({name:e.name||`Unnamed Attachment`,path:e.path,extension:_(e.path)})}return t}function _(e){return e.replace(/.*\./,``).toLowerCase()}function v(e){let t=o(e),n={};return t(`audio source, video source`).each(function(){let e=t(this).attr(`src`);if(!e)return;let r=_(e),i=l[r];if(i)return n={enclosure_url:new URL(e,s).toString(),enclosure_type:i},!1}),n}async function y(o,c){let l=await Promise.all(o.map(o=>e.tryGet(`discord_${o.id}`,async()=>{let e=await i({method:`get`,url:`${s}/api/v1/discord/channel/${o.id}?o=0`,headers:u});return e.data.filter(e=>e.content||e.attachments).sort((e,t)=>t.id.localeCompare(e.id)).slice(0,c).map(e=>({title:e.content||`Discord Message`,description:t(a.join(r,`templates/discord-b75b214c.art`),{i:e}),author:`${e.author.username}#${e.author.discriminator}`,pubDate:n(e.published),category:o.name,guid:`kemono:discord:${e.server}:${e.channel}:${e.id}`,link:`https://discord.com/channels/${e.server}/${e.channel}/${e.id}`}))})));return l.flat()}function b(e,t,r,i,a){return e.slice(0,a).map(e=>({title:`Announcement from ${e.published?n(e.published).toDateString():`Unknown Date`}`,description:`<div>${e.content||``}</div>`,author:t,pubDate:n(e.published),guid:`kemono:${r}:${i}:announcement:${e.hash}`,link:`${s}/${r}/user/${i}/announcements`}))}function x(e,t,r,i,a){return e.slice(0,a).map(e=>{let a=`${e.server}${e.path}`;return{title:`Fancard ${e.id}`,description:`<img src="${a}" alt="Fancard ${e.id}" />`,author:t,pubDate:n(e.added),guid:`kemono:${r}:${i}:fancard:${e.id}`,link:a,enclosure_url:a,enclosure_type:e.mime}})}function S(e,i,c){return e.filter(e=>e.content||e.attachments).slice(0,c).map(e=>{let c=g(e),l={...e,files:c},u=t(a.join(r,`templates/source-7bbf197e.art`),{i:l}),d=e.content?`<div>${e.content}</div>`:``,f=o(d),p=o(u)(`img, a, audio, video`).toArray().map(e=>f(e).prop(`outerHTML`)),m=0,h=/downloads\.fanbox\.cc/;f(`a`).each(function(){let e=f(this).attr(`href`);e&&h.test(e)&&(f(this).replaceWith(p[m]||``),m++)}),d=(p[0]||``)+f.html();for(let e of p.slice(m+1))d+=e;return{title:e.title||`Untitled Post`,description:d,author:i,pubDate:n(e.published),guid:`kemono:${e.service}:${e.user}:post:${e.id}`,link:`${s}/${e.service}/user/${e.user}/post/${e.id}`,...v(d)}})}async function C(e){let t=e.req.query(`limit`)?Number.parseInt(e.req.query(`limit`)):25,n=e.req.param(`source`)||`posts`,r=e.req.param(`id`),a=e.req.param(`type`),o=n===`posts`,c=n===`discord`;try{let e=p(n,r,a),l=m(n,r,a),d=await i({method:`get`,url:e,headers:u}),f=o||c||!r?``:await h(n,r),g=o||c?`${s}/favicon.ico`:`https://img.kemono.cr/icons/${n}/${r}`,_,v;if(c)v=`Posts of ${r} from Discord | Kemono`,_=await y(d.data,t);else if(a===`announcements`)v=`Announcements of ${f} from ${n} | Kemono`,_=b(d.data,f,n,r,t);else if(a===`fancards`)v=`Fancards of ${f} from ${n} | Kemono`,_=x(d.data,f,n,r,t);else{v=o?`Kemono Posts`:`Posts of ${f} from ${n} | Kemono`;let e=o?d.data.posts:d.data;_=S(e,f,t)}return{title:v,image:g,link:l,item:_}}catch(e){throw Error(`Failed to fetch data from Kemono: ${e instanceof Error?e.message:`Unknown error`}`)}}export{d as route};