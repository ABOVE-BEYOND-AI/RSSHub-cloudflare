import"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import"./helpers-LVq640iW.js";import{art as e}from"./render-DE4LRFBD.js";import{parseDate as t}from"./parse-date-DHsdom8D.js";import{getSubPath as n}from"./common-utils-C27Jp3s6.js";import"./ofetch-DRl42yaJ.js";import{__dirname as r}from"./esm-shims-BDPl6Msv.js";import{got_default as i}from"./got-BaOFZRd4.js";import{timezone as a}from"./timezone-BrxBCotj.js";import o from"node:path";import s from"dayjs";import{load as c}from"cheerio";const l=`https://www.dlsite.com`,u={show_type:1,show_layout:1,per_page:100},d=(e,t)=>s(e).format(t),f=(e,t)=>{let n=Object.keys(t),r=n.map(e=>`/${e}/${t[e]}`).join(``),i=e.replaceAll(RegExp(`(/${n.join(String.raw`/\w+|/`)}/\\w+)`,`g`),``);return`${i}${/=/.test(i)?``:`/=`}${r}`},p=e=>{let n=e.match(/(\d{4}).*(\d{2}).*(\d{2})/);return n?t(`${n[1]}-${n[2]}-${n[3]}`,`YYYY-MM-DD`):t(e.split(`:`).pop().trim(),`MMM/DD/YYYY`)},m=async e=>{let t=`${l}/home-touch/product/info/ajax?product_id=${e}`,n=await i({method:`get`,url:t});return n.data},h=async h=>{e.defaults.imports.formatDate=d;let g=n(h)===`/`?`/home/new`:n(h),_=h.req.query(`limit`)?Number.parseInt(h.req.query(`limit`)):100,v=`${l}${f(g,u)}`,y=await i({method:`get`,url:v}),b=c(y.data),x=b(`dt.work_name`).slice(0,_),S=b(`.work_update`).length===0?void 0:p(b(`.work_update`).text()),C=await m(x.toArray().map(e=>b(e).find(`a`).attr(`href`).match(/_id\/(.*?)\.html/)[1]).join(`,`)),w=x.toArray().map(n=>{n=b(n).parentsUntil(`tbody, ul`);let i=n.find(`.work_name a`),c=i.text(),l=i.attr(`href`),u=l.match(/_id\/(.*?)\.html/)[1],d=n.find(`.work_text`).text(),f=n.find(`.maker_name a`).toArray().map(e=>({name:b(e).text(),link:b(e).attr(`href`)})),p=n.find(`div[data-samples]`).length===0?[]:JSON.parse(n.find(`div[data-samples]`).attr(`data-samples`).replaceAll(`'`,`"`)).map(e=>e.thumb),m=n.find(`.work_category`).find(`a`).toArray().map(e=>({text:b(e).text(),link:b(e).attr(`href`)})),h=n.find(`.work_genre`).find(`span[title]`).toArray().map(e=>({text:b(e).text()})),g=n.find(`.search_tag`).find(`a`).toArray().map(e=>({text:b(e).text(),link:b(e).attr(`href`)})),_=n.find(`.icon_wrap`).find(`span[title]`).toArray().map(e=>({text:b(e).text()})),v=C[u],y=a(t(v.regist_date),9),x=v.discount_rate,w=v.discount_end_date?a(t(v.discount_end_date,`MM/DD HH:mm`),9):void 0;return p=p.length===0?[v.work_image]:p,{title:`${x?`${x}% OFF
                        ${` ${w?`${s(w).format(`YYYY-MM-DD HH:mm`)} まで`:``}`}`:` `}${c}`,link:l,pubDate:y,author:f.map(e=>e.name).join(` / `),category:[...m.map(e=>e.text),...h.map(e=>e.text),...g.map(e=>e.text),..._.map(e=>e.text)],guid:`dlsite-${u}`,description:e(o.join(r,`templates/description-3ff6e827.art`),{detail:v,images:p,authors:f,discountRate:x,discountEndDate:w,updatedDate:S,pubDate:y,workCategories:m,workGenres:h,searchTags:g,description:d})}});return{title:b(`title`).text(),description:b(`meta[name="description"]`).attr(`content`),link:v,item:w,allowEmpty:!0}},g={path:`*`,name:`Unknown`,maintainers:[],handler:_};async function _(e){return await h(e)}export{g as route};