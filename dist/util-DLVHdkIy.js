import{config as e}from"./config-HRWLmo66.js";import{art as t}from"./render-DE4LRFBD.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import{ofetch_default as r}from"./ofetch-DRl42yaJ.js";import{__dirname as i}from"./esm-shims-BDPl6Msv.js";import{got_default as a}from"./got-BaOFZRd4.js";import{config_not_found_default as o}from"./config-not-found-B7nOMdXp.js";import s from"node:path";import{load as c}from"cheerio";const l=`https://nhentai.net`,u=async(e,t,n)=>{let r=`https://nhentai.net/login/`,i=`nhentai:cookie`,o=await n.get(i);if(o){let{cookie:e,time:t}=JSON.parse(o),n=Date.now();if(n-t<86400*3*1e3)return e}let{data:s,headers:c}=await a(r),l=s.match(/name="csrfmiddlewaretoken" value="(.*?)"/)[1],u=c[`set-cookie`].map(e=>e.split(`;`)[0]).join(`; `),d=await a.post(r,{headers:{referer:r,cookie:u},form:{csrfmiddlewaretoken:l,username_or_email:e,password:t,next:``},followRedirect:!1});if(d.statusCode!==302)return n.set(i,JSON.stringify({cookie:``,time:Date.now()})),``;let f=d.headers[`set-cookie`].map(e=>e.split(`;`)[0]).join(`; `);return n.set(i,JSON.stringify({cookie:f,time:Date.now()})),f},d=(e,...t)=>r(e,{...t,headers:{host:`nhentai.net`}}),f=async e=>{let t=await d(e),n=c(t);return n(`.gallery a.cover`).toArray().map(e=>g(n(e)))},p=(e,t,n)=>Promise.all(t.slice(0,n).map(t=>e.tryGet(t.link,()=>v(t)))),m=async(t,n,r)=>{if(!e.nhentai||!e.nhentai.username||!e.nhentai.password)throw new o(`nhentai RSS with torrents is disabled due to the lack of <a href="https://docs.rsshub.app/deploy/config#route-specific-configurations">relevant config</a>`);let i=await u(e.nhentai.username,e.nhentai.password,t);if(!i)throw new o(`Invalid username (or email) or password for nhentai torrent download`);return h(t,n,i,r)},h=(e,t,n,r)=>Promise.all(t.slice(0,r).map(t=>e.tryGet(t.link+`download`,()=>_(t,n)))),g=e=>{let t=new URL(e.attr(`href`),l).href,n=e.children(`img`),r=n.attr(`data-src`)||n.attr(`src`),i=r.replace(`thumb`,`1`).replace(/t(\d+)\.nhentai\.net/,`i$1.nhentai.net`).replace(`.webp.webp`,`.webp`);return{title:e.children(`.caption`).text(),link:t,description:`<img src="${i}">`}},_=async(e,t)=>{let{link:n}=e,r=await d(n+`download`,{followRedirect:!1,responseType:`buffer`,headers:{Cookie:t}});return{...e,enclosure_url:r,enclosure_type:`application/x-bittorrent`}},v=async e=>{let{link:r}=e,a=await d(r),o=c(a),u=o(`.gallerythumb img`).toArray().map(e=>new URL(o(e).attr(`data-src`),l).href).map(e=>e.replace(/(.+)(\d+)t\.(.+)/,(e,t,n,r)=>`${t}${n}.${r}`)).map(e=>e.replace(/t(\d+)\.nhentai\.net/,`i$1.nhentai.net`)).map(e=>e.replace(/\.(jpg|png|gif)\.webp$/,`.$1`)).map(e=>e.replace(/\.webp\.webp$/,`.webp`));return{...e,title:o(`div#info > h2`).text()||o(`div#info > h1`).text(),pubDate:n(o(`time`).attr(`datetime`)),description:t(s.join(i,`templates/desc-9360b66a.art`),{length:u.length,images:u})}};export{p as getDetails,f as getSimple,m as getTorrents};