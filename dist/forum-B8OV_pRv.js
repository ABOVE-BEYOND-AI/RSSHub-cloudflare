import"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import{cache_default as e}from"./cache-C3AIQtoX.js";import{art as t}from"./render-DE4LRFBD.js";import{parseDate as n}from"./parse-date-DHsdom8D.js";import{md5 as r}from"./md5-15Cn4YyR.js";import{ofetch_default as i}from"./ofetch-DRl42yaJ.js";import{__dirname as a}from"./esm-shims-BDPl6Msv.js";import{timezone as o}from"./timezone-BrxBCotj.js";import s from"node:path";import{load as c}from"cheerio";const l={path:`/:id?`,name:`分类`,url:`4ksj.com`,maintainers:[`nczitzk`],handler:d,example:`/4ksj/4k-uhd-1`,parameters:{id:`分类 id，默认为最新4K电影`},description:"::: tip\n  若订阅 [最新 4K 电影](https://www.4ksj.com/4k-uhd-1.html)，网址为 `https://www.4ksj.com/4k-uhd-1.html`。截取 `https://www.4ksj.com/` 到末尾 `.html` 的部分 `4k-uhd-1` 作为参数，此时路由为 [`/4ksj/4k-uhd-1`](https://rsshub.app/4ksj/4k-uhd-1)。\n\n  若订阅子分类 [Dolby Vision 动作 4K 电影](https://www.4ksj.com/4k-uhd-s7-display-3-dytypes-1-1.html)，网址为 `https://www.4ksj.com/4k-uhd-s7-display-3-dytypes-1-1.html`。截取 `https://www.4ksj.com/forum-` 到末尾 `.html` 的部分 `4kdianying-s7-dianyingbiaozhun-3-dytypes-9-1` 作为参数，此时路由为 [`/4ksj/4k-uhd-s7-display-3-dytypes-1-1`](https://rsshub.app/4ksj/4k-uhd-s7-display-3-dytypes-1-1)。\n:::",categories:[`multimedia`]};function u(e){let t=``;for(let n=0;n<=e.length-1;n++){let r=e.charAt(n),i=r.codePointAt();t+=i}return t}async function d(l){let{id:d=`4k-uhd-1`}=l.req.param(),f=l.req.query(`limit`)?Number.parseInt(l.req.query(`limit`)):25,p=`https://www.4ksj.com`,m=new URL(`${d}.html`,p).href,h=await i(m,{responseType:`arrayBuffer`}),g=new TextDecoder(`gbk`),_=c(g.decode(h)),v=_(`div.nexlogo img`).prop(`src`),y=_(`div.nex_cmo_piv a`).slice(0,f).toArray().map(e=>(e=_(e),{link:new URL(e.prop(`href`),p).href})),b=()=>e.tryGet(`4ksj:cookie`,async()=>{let e=await i(y[0].link),t=c(e),n=t(`script`).attr(`src`),a=new URL(n,p).href,o=await i(a),s=o.match(/{var key="(.*?)"/)?.[1],l=o.match(/",value="(.*?)"/)?.[1],d=o.match(/\.get\("(.*?&key=)"/)?.[1];if(!s||!l||!d)throw Error(`Failed to get cookie`);let f=await i.raw(`${p}${d}${s}&value=${r(u(l))}`);return f.headers.getSetCookie().map(e=>e.split(`;`)[0]).join(`; `)}),x=await b();return y=await Promise.all(y.map(r=>e.tryGet(r.link,async()=>{let e=await i(r.link,{responseType:`arrayBuffer`,headers:{Cookie:x}}),l=c(g.decode(e));l(`div.nex_drama_intros em`).first().remove(),l(`strong font`).each((e,t)=>{t=l(t),t.parent().remove()});let u=l(`div.nex_drama_Top h5`).text(),d=l(`div.nex_drama_intros`).html(),f=l(`div.nex_drama_pic`).html().match(/background:url\((.*?)\)/)?.[1]??``,p=l(`li.nex_drama_Detail_li, li.nex_drama_Detail_lis dd`).toArray().map(e=>{e=l(e);let t=e.find(`em`).text().replaceAll(/：|\s/g,``),n=e.find(`span`).length===0?e.contents().last().text().trim():e.find(`span`).text().trim();return{[t]:n}}),m=Object.assign({},...p),h=l(`td.t_f ignore_js_op`).length===0?l(`td.t_f strong`).toArray().map(e=>{e=l(e);let t=e.contents().first().text(),n=e.next().prop(`href`)??e.nextUntil(`a`).next().prop(`href`);return r.enclosure_url=r.enclosure_url??n,r.enclosure_type=r.enclosure_type??`application/x-bittorrent`,r.enclosure_title=r.enclosure_title??t,{title:t,tags:e.contents().last().text().match(/【(.*?)】/g),link:n}}):l(`div.newfujian`).toArray().map(e=>(e=l(e),{title:e.find(`p.filename`).prop(`title`)||e.find(`p.filename`).text(),tags:e.find(`div.fileaq`).text().match(/【(.*?)】/g),link:e.find(`div.down_2 a`).prop(`href`)})),_=l(`table.boxtable em`).first(),v=_.find(`span[title]`).length===0?_.first().text().replace(/发表于\s/,``):_.find(`span[title]`).prop(`title`);return r.title=u,r.description=t(s.join(a,`templates/description-6a5b9b89.art`),{images:f?[{src:f,alt:u}]:void 0,title:u,keys:Object.keys(m),details:m,description:d,info:l(`div.nex_drama_sums`).html(),links:h}),r.pubDate=o(n(v,`YYYY-M-D HH:mm:ss`),8),r.category=Object.values(m).flatMap(e=>e.split(/\s/)).filter(Boolean),r.author=m.导演,r.content={html:d,text:l(`div.nex_drama_intros`).text()},r.image=f,r.banner=f,r.language=`zh`,r}))),{title:`4k世界 - ${_(`#fontsearch ul.cl li.a`).toArray().map(e=>_(e).text()).join(`+`)||`不限`}`,description:_(`meta[name="description"]`).prop(`content`),link:m,item:y,allowEmpty:!0,image:v,author:_(`meta[name="application-name"]`).prop(`content`),language:`zh`}}export{l as route};