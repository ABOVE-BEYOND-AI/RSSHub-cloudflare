import{config as e}from"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import"./helpers-LVq640iW.js";import{cache_default as t}from"./cache-C3AIQtoX.js";import{art as n}from"./render-DE4LRFBD.js";import{parseDate as r}from"./parse-date-DHsdom8D.js";import"./ofetch-DRl42yaJ.js";import{__dirname as i}from"./esm-shims-BDPl6Msv.js";import{got_default as a}from"./got-BaOFZRd4.js";import{timezone as o}from"./timezone-BrxBCotj.js";import s from"node:path";import{load as c}from"cheerio";const l={path:`/digest/:tid`,categories:[`bbs`],example:`/saraba1st/digest/forum-6-1`,parameters:{tid:`论坛 id`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`论坛摘要`,maintainers:[`shinemoon`],handler:u,description:"版面网址如果为 `https://stage1st.com/2b/forum-6-1.html` 那么论坛 id 就是 `forum-6-1`。"};async function u(n){let i=n.req.param(`tid`),s=e.saraba1st.cookie??``,l=e.saraba1st.host,u=await a(`${l}/2b/${i}.html`,{headers:{Cookie:s}}),f=c(u.data),p=f(`head title`).text().replace(/-.*/,``),m=f(`#threadlisttableid tbody[id^="normalthread_"] tr`),h=m.slice(0,n.req.query(`limit`)?Number(n.req.query(`limit`)):20).toArray().map(e=>{e=f(e);let t=e.find(`th.new a.s.xst`).text(),n=e.find(`th.new a.s.xst`).attr(`href`);return{title:`${p}:${t}`,link:new URL(n,`${l}/2b/`).href,author:e.find(`td.by cite`).text(),pubDate:o(r(e.find(`td.by em`).first().text()),8)}}),g=await Promise.all(h.map(e=>t.tryGet(e.link,async()=>(e.description=await d(e.link),e))));return{title:`Stage1 论坛 - ${p}`,link:`${l}/2b/${i}.html`,item:g}}async function d(t){let r=e.saraba1st.cookie??``,o=await a(t,{headers:{Cookie:r}}),l=c(o.data),u=l(`<div>`);return l(`#postlist`).find(`div[id*="post_"] `).each(function(){if(l(this).find(`td[id*="postmessage_"]`).length>0){let t=n(s.join(i,`templates/digest-09816a49.art`),{author:{link:l(this).find(`.pls.favatar div.authi a`).attr(`href`),name:l(this).find(`.pls.favatar div.authi`).text(),postinfo:l(this).find(`div.authi em[id*=authorposton]`).text()},msg:l(this).find(`td[id*="postmessage_"]`).html(),host:e.saraba1st.host});u.append(t)}}),u.find(`img`).each(function(){let e=l(this),t=e.attr(`file`);t&&(e.attr(`src`,t),e.removeAttr(`zoomfile`),e.removeAttr(`file`),e.removeAttr(`onmouseover`),e.removeAttr(`onclick`))}),u.html()}export{l as route};