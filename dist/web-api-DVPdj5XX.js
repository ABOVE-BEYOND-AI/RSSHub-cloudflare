import{config as e}from"./config-HRWLmo66.js";import"./logger-DHpG8Bim.js";import{cache_default as t}from"./cache-C3AIQtoX.js";import{art as n}from"./render-DE4LRFBD.js";import{parseDate as r}from"./parse-date-DHsdom8D.js";import{ofetch_default as i}from"./ofetch-DRl42yaJ.js";import{__dirname as a}from"./esm-shims-BDPl6Msv.js";import{invalid_parameter_default as o}from"./invalid-parameter-CfUmvEUg.js";import{config_not_found_default as s}from"./config-not-found-B7nOMdXp.js";import{renderItems as c}from"./common-utils-Bx_NYDHw.js";import l from"node:path";import{CookieJar as u}from"tough-cookie";const d=`https://www.instagram.com`,f=d,p=async e=>{let t=await e.getCookieString(f);return t.match(/csrftoken=([^;]+)/)?.[1]},m=async e=>({"sec-fetch-dest":`empty`,"sec-fetch-mode":`cors`,"sec-fetch-site":`same-origin`,"x-asbd-id":359341,"x-csrftoken":await p(e),"x-ig-app-id":936619743392459,"x-ig-www-claim":`0`}),h=async e=>{let t=await i(`${d}/api/v1/web/fxcal/ig_sso_users/`,{headers:{"content-type":`application/x-www-form-urlencoded`,cookie:await e.getCookieString(f),...await m(e)},method:`POST`});return t.status===`ok`},g=async(e,n)=>{let r,a=await t.get(`instagram:getIdByUsername:${e}`),o=await t.get(`instagram:userInfo:${a}`);if(o=o&&typeof o==`string`?JSON.parse(o):o,!o)try{let o=await i.raw(`${d}/api/v1/users/web_profile_info/`,{headers:{cookie:await n.getCookieString(f),...await m(n)},query:{username:e}});if(o.url.includes(`/accounts/login/`))throw new s(`Invalid cookie`);r=o._data.data.user,a=r.id,await t.set(`instagram:getIdByUsername:${e}`,a,31536e3),await t.set(`instagram:userInfo:${a}`,r)}catch(e){throw e.message.includes(`Cookie not in this host's domain`)?new s(`Invalid cookie`):e}return o||r},_=(n,r,a)=>t.tryGet(`instagram:feed:${n}`,async()=>{let e=await i.raw(`${d}/api/v1/feed/user/${r}/username/`,{headers:{cookie:await a.getCookieString(f),...await m(a)},query:{count:30}});if(e.url.includes(`/accounts/login/`))throw new s(`Invalid cookie.
                Please also check if your account is being blocked by Instagram.`);return e._data.items},e.cache.routeExpire,!1),v=(n,r)=>t.tryGet(`instagram:tags:${n}`,async()=>{let e=await i(`${d}/api/v1/tags/web_info/`,{headers:{cookie:await r.getCookieString(f),...await m(r)},query:{tag_name:n}});return e.data},e.cache.routeExpire,!1),y=e=>{let t=(e,t)=>n(l.join(a,`templates/video-fb8df18d.art`),{summary:t,image:e.display_url,video:{url:e.video_url,height:e.dimensions.height,width:e.dimensions.width}}),i=(e,t)=>n(l.join(a,`templates/images-105c7ff0.art`),{summary:t,images:[{url:e.display_url,height:e.dimensions.height,width:e.dimensions.width}]});return e.map(({node:e})=>{let n=e.__typename,a=e.edge_media_to_caption.edges[0]?.node.text??``,o=``;switch(n){case`GraphSidecar`:o=e.edge_sidecar_to_children?e.edge_sidecar_to_children.edges.map(({node:e},n)=>{let r=e.__typename;switch(r){case`GraphVideo`:return t(e,n===0?a:``);case`GraphImage`:return i(e,n===0?a:``);default:throw Error(`Instagram: Unhandled carousel type: ${r}`)}}).join(``):i(e,a);break;case`GraphVideo`:o=t(e,a);break;case`GraphImage`:o=i(e,a);break;default:throw Error(`Instagram: Unhandled feed type: ${n}`)}return{title:a.split(`
`)[0],id:e.id,pubDate:r(e.taken_at_timestamp,`X`),author:e.owner.username,link:`${d}/p/${e.shortcode}/`,summary:a,description:o}})},b={path:`/2/:category/:key`,categories:[`social-media`],example:`/instagram/2/user/stefaniejoosten`,parameters:{category:`Feed category, see table below`,key:`Username / Hashtag name`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!0,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`User Profile / Hashtag`,maintainers:[`TonyRL`],handler:x,description:`::: tip
You may need to setup cookie for a less restrictive rate limit and private profiles.
:::


| User timeline | Hashtag |
| ------------- | ------- |
| user          | tags    |`};async function x(n){let r=[`user`,`tags`],{category:i,key:a}=n.req.param(),{cookie:l}=e.instagram;if(!r.includes(i))throw new o(`Such feed is not supported.`);let p=await t.get(`instagram:cookieJar`),m=!p;if(m){if(p=new u,l)for await(let e of l.split(`; `))await p.setCookie(e,f)}else p=u.fromJSON(p);if(l&&!await h(p))throw new s(`Invalid cookie`);let b,x,S,C,w;switch(i){case`user`:{let e=await g(a,p),t=e.biography,n=e.full_name,r=e.id,i=e.username;b=`${n} (@${i}) - Instagram`,S=t,C=e.profile_pic_url_hd??e.hd_profile_pic_url_info?.url??e.profile_pic_url,x=`${d}/${i}`,w=l?await _(r,i,p):[...e.edge_felix_video_timeline.edges,...e.edge_owner_to_timeline_media.edges];break}case`tags`:{if(!e.instagram||!e.instagram.cookie)throw new s(`Instagram RSS is disabled due to the lack of <a href="https://docs.rsshub.app/deploy/config#route-specific-configurations">relevant config</a>`);let t=a;b=`#${t} - Instagram`,x=`${d}/explore/search/keyword/?q=%23${t}`;let n=await v(t,p);C=n.profile_pic_url,w=n.top.sections.flatMap(e=>(e.feed_type===`media`?e.layout_content.medias:[...e.layout_content.one_by_two_item.clips.items,...e.layout_content.fill_items]).map(e=>e.media));break}default:break}return await t.set(`instagram:cookieJar`,p.toJSON(),31536e3),{title:b,link:x,description:S,item:l?c(w):y(w),icon:`${d}/static/images/ico/xxhdpi_launcher.png/99cf3909d459.png`,logo:C,image:C,allowEmpty:!0}}export{b as route};